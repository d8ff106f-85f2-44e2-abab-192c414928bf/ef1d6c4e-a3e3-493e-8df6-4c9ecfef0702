<input type="file" id="upload">
<button id="button" onclick="onUpload()">Load Model</button><br>
<input type="range" id="slider" min="0" max="1" valeu="0.5" step="0.0000152587890625" style="width:100%">
<pre id="output"></pre>
<script>
const output = document.getElementById('output');
const button = document.getElementById('button');
const upload = document.getElementById('upload');
const slider = document.getElementById('slider');
slider.addEventListener("input", handle_slider);
let slicer_wasm = {};
let slicer_data = 0;
let slider_value = slider.value;
function handle_slider(event) {
    slider_value = event.target.value;
    const cuts = slicer_wasm.instance.exports.reslice(slicer_data, slider_value);
    console.log(cuts);
}


async function onUpload() {
    button.disabled = true;
    const file_stream = upload.files[0].stream();
    const file_size = upload.files[0].size;
    const parser_memory = new WebAssembly.Memory({
        initial: 17,
        maximum: 65536,
    });

    const parser = await WebAssembly.instantiateStreaming(
        await fetch("wasm-parser.wasm"),
        {
            env: { 
                memory: parser_memory,
                log_node_start: ()=>console.log("parsing nodes..."), 
                log_elem_start: ()=>console.log("parsing elems..."),
            },
        },
    );

    const file_ptr = parser.instance.exports.initMemory(file_size);
    if (file_ptr == 0) {
        console.log("failed to init parser memory");
        return;
    }


    const destination = new Uint8Array(parser_memory.buffer, file_ptr, file_size);
    let offset = 0;
    for await (const chunk of file_stream) {
        destination.set(chunk, offset);
        offset += chunk.length;
    }

    console.log("parsing model...");
    const meta_ptr = parser.instance.exports.parseModel(file_ptr, file_size);
    if (meta_ptr == 0) {
        console.log("failed to parse model");
        return;
    }

    
    const meta = new Uint32Array(parser_memory.buffer, meta_ptr, 7);
    output.textContent += ("nodes_count: " + meta[0] + "\n");
    output.textContent += ("elems_count: " + meta[1] + "\n");
    output.textContent += ("nodes_x_ptr: " + meta[2] + "\n");
    output.textContent += ("nodes_y_ptr: " + meta[3] + "\n");
    output.textContent += ("nodes_z_ptr: " + meta[4] + "\n");
    output.textContent += ("elems_v_ptr: " + meta[5] + "\n");
    output.textContent += ("nodes_n_ptr: " + meta[6] + "\n");
    output.textContent += ("file_size: " + file_size + "\n");



    
    const nodes_count = meta[0];
    const elems_count = meta[1];
    const nodes_x_ptr = meta[2];
    const nodes_y_ptr = meta[3];
    const nodes_z_ptr = meta[4];
    const elems_v_ptr = meta[5];
    const nodes_n_ptr = meta[6];

    

    const xs_src = new Float32Array(parser_memory.buffer, nodes_x_ptr, nodes_count);
    const ys_src = new Float32Array(parser_memory.buffer, nodes_y_ptr, nodes_count);
    const zs_src = new Float32Array(parser_memory.buffer, nodes_z_ptr, nodes_count);
    const tets_src = new Uint32Array(parser_memory.buffer, elems_v_ptr, elems_count * 4);
    const ns_src = new Uint32Array(parser_memory.buffer, nodes_n_ptr, nodes_count);


    const slicer_memory = new WebAssembly.Memory({
        initial: 17,
        maximum: 65536,
    });

    const slicer = await WebAssembly.instantiateStreaming(
        await fetch("wasm-slicer.wasm"),
        {
            env: { 
                memory: slicer_memory,
            },
        },
    );


    const data_ptr = slicer.instance.exports.initMemory(nodes_count, elems_count);
    if (data_ptr == 0) {
        console.log("failed to init slicer memory");
        return;
    }

    const data = new Uint32Array(slicer_memory.buffer, data_ptr, 26);

    const ns_dst = new Uint32Array(slicer_memory.buffer, data[1], nodes_count);
    const xs_dst = new Float32Array(slicer_memory.buffer, data[2], nodes_count);
    const ys_dst = new Float32Array(slicer_memory.buffer, data[3], nodes_count);
    const zs_dst = new Float32Array(slicer_memory.buffer, data[4], nodes_count);
    const tets_dst = new Uint32Array(slicer_memory.buffer, data[13], elems_count * 4);

    ns_dst.set(ns_src);
    xs_dst.set(xs_src);
    ys_dst.set(ys_src);
    zs_dst.set(zs_src);
    tets_dst.set(tets_src);

    console.log(ns_dst[0]);
    console.log(xs_dst[0]);
    console.log(ys_dst[0]);
    console.log(zs_dst[0]);

    console.log(ns_dst[nodes_count-1]);
    console.log(xs_dst[nodes_count-1]);
    console.log(ys_dst[nodes_count-1]);
    console.log(zs_dst[nodes_count-1]);

    console.log("reoreinting...");
    slicer.instance.exports.reorient(data_ptr, 0.5, 0.5, 0.5, 0.5 );

    console.log("reslicing...");
    const cuts = slicer.instance.exports.reslice(data_ptr, 0.5);
    console.log(cuts);

    slicer_wasm = slicer;
    slicer_data = data_ptr;

    button.disabled = false;
}
</script>