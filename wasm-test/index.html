<input type="file" id="upload">
<button id="button" onclick="onUpload()">Load Model</button>
<pre id="output"></pre>
<script>
const output = document.getElementById('output');
const button = document.getElementById('button');
const upload = document.getElementById('upload');
async function onUpload() {
    button.disabled = true;
    const file_stream = upload.files[0].stream();
    const file_size = upload.files[0].size;
    const memory = new WebAssembly.Memory({
        initial: 17,
        maximum: 65536,
    });

    const wasm = await WebAssembly.instantiateStreaming(
        await fetch("wasm-parser.wasm"),
        {
            env: { 
                memory,
                log_node_start: ()=>console.log("parsing nodes..."), 
                log_elem_start: ()=>console.log("parsing elems..."),
            },
        },
    );

    const file_ptr = wasm.instance.exports.initMemory(file_size);
    if (file_ptr == 0) {
        console.log("failed to init memory");
        return;
    }


    const destination = new Uint8Array(memory.buffer, file_ptr, file_size);
    let offset = 0;
    for await (const chunk of file_stream) {
        destination.set(chunk, offset);
        offset += chunk.length;
    }

    console.log("parsing model...");
    const meta_ptr = wasm.instance.exports.parseModel(file_ptr, file_size);
    if (meta_ptr == 0) {
        console.log("failed to parse model");
        return;
    }

    
    const meta = new Uint32Array(memory.buffer, meta_ptr, 6);
    output.textContent += ("nodes_count: " + meta[0] + "\n");
    output.textContent += ("elems_count: " + meta[1] + "\n");
    output.textContent += ("nodes_x_ptr: " + meta[2] + "\n");
    output.textContent += ("nodes_y_ptr: " + meta[3] + "\n");
    output.textContent += ("nodes_z_ptr: " + meta[4] + "\n");
    output.textContent += ("elems_v_ptr: " + meta[5] + "\n");
    output.textContent += ("file_size: " + file_size + "\n");

    button.disabled = false;
}
</script>